#include "stm32f4xx.h"
#include "motorcontroller.h"
#include "CAN.h"
#include "Bamocar.h"

#define MAXRPM 1250

uint8_t wheelFrontR, wheelRearR, wheelFrontL, wheelRearL, wheelsRightUpdated, wheelsLeftUpdated;
uint16_t torqueSetpoint, brakeSetpoint;
uint8_t  steeringDirection, steeringDegrees;
uint16_t torqueR, torqueL;
double forhold;

const uint16_t simple_ackerman[101][38] = {
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{328,325,322,319,316,313,310,308,305,302,299,296,293,290,287,284,281,278,274,271,268,265,261,258,255,251,248,244,241,237,233,229,225,221,217,213,209,204},
{655,650,644,638,632,627,621,615,609,603,598,592,586,580,574,568,561,555,549,543,536,530,523,516,509,503,496,488,481,474,466,458,451,443,434,426,417,408},
{983,974,966,957,949,940,931,923,914,905,896,887,879,870,860,851,842,833,823,814,804,794,784,774,764,754,743,733,722,711,699,688,676,664,651,639,626,613},
{1311,1299,1288,1276,1265,1253,1242,1230,1219,1207,1195,1183,1171,1159,1147,1135,1123,1110,1098,1085,1072,1059,1046,1033,1019,1005,991,977,962,947,932,917,901,885,869,852,835,817},
{1638,1624,1610,1595,1581,1567,1552,1538,1523,1509,1494,1479,1464,1449,1434,1419,1403,1388,1372,1356,1340,1324,1307,1291,1274,1256,1239,1221,1203,1184,1165,1146,1126,1106,1086,1065,1043,1021},
{1966,1949,1932,1915,1897,1880,1863,1845,1828,1810,1793,1775,1757,1739,1721,1703,1684,1665,1647,1628,1608,1589,1569,1549,1528,1508,1487,1465,1443,1421,1398,1375,1352,1328,1303,1278,1252,1225},
{2294,2274,2254,2234,2213,2193,2173,2153,2133,2112,2091,2071,2050,2029,2008,1986,1965,1943,1921,1899,1876,1853,1830,1807,1783,1759,1734,1709,1684,1658,1632,1605,1577,1549,1520,1491,1460,1429},
{2621,2598,2576,2553,2530,2507,2484,2460,2437,2414,2390,2367,2343,2319,2295,2270,2246,2221,2195,2170,2144,2118,2092,2065,2038,2010,1982,1954,1924,1895,1865,1834,1802,1770,1737,1704,1669,1634},
{2949,2923,2898,2872,2846,2820,2794,2768,2742,2715,2689,2662,2636,2609,2581,2554,2526,2498,2470,2441,2412,2383,2353,2323,2293,2261,2230,2198,2165,2132,2098,2063,2028,1991,1954,1917,1878,1838},
{3277,3248,3219,3191,3162,3133,3105,3076,3046,3017,2988,2958,2928,2898,2868,2838,2807,2776,2744,2713,2680,2648,2615,2581,2547,2513,2478,2442,2406,2369,2331,2292,2253,2213,2172,2130,2086,2042},
{3604,3573,3541,3510,3478,3447,3415,3383,3351,3319,3287,3254,3221,3188,3155,3121,3088,3053,3019,2984,2948,2913,2876,2839,2802,2764,2725,2686,2646,2605,2564,2522,2478,2434,2389,2342,2295,2246},
{3932,3898,3863,3829,3795,3760,3725,3691,3656,3621,3585,3550,3514,3478,3442,3405,3368,3331,3293,3255,3216,3177,3138,3098,3057,3015,2973,2930,2887,2842,2797,2751,2704,2655,2606,2555,2504,2451},
{4260,4223,4185,4148,4111,4073,4036,3998,3960,3922,3884,3846,3807,3768,3729,3689,3649,3609,3568,3526,3485,3442,3399,3356,3311,3267,3221,3174,3127,3079,3030,2980,2929,2877,2823,2768,2712,2655},
{4587,4547,4507,4467,4427,4387,4346,4306,4265,4224,4183,4142,4100,4058,4015,3973,3930,3886,3842,3798,3753,3707,3661,3614,3566,3518,3469,3419,3368,3316,3263,3209,3154,3098,3040,2981,2921,2859},
{4915,4872,4829,4786,4743,4700,4657,4613,4570,4526,4482,4437,4393,4348,4302,4257,4210,4164,4117,4069,4021,3972,3922,3872,3821,3769,3716,3663,3608,3553,3496,3438,3379,3319,3257,3194,3130,3063},
{5243,5197,5151,5105,5059,5013,4967,4921,4874,4828,4781,4733,4686,4638,4589,4540,4491,4441,4391,4340,4289,4236,4184,4130,4076,4020,3964,3907,3849,3790,3729,3668,3605,3540,3475,3407,3338,3267},
{5570,5522,5473,5424,5376,5327,5278,5228,5179,5129,5079,5029,4978,4927,4876,4824,4772,4719,4665,4611,4557,4501,4445,4388,4330,4272,4212,4151,4089,4027,3962,3897,3830,3762,3692,3620,3547,3472},
{5898,5847,5795,5744,5692,5640,5588,5536,5484,5431,5378,5325,5271,5217,5163,5108,5052,4996,4940,4883,4825,4766,4707,4646,4585,4523,4460,4395,4330,4263,4195,4126,4055,3983,3909,3833,3755,3676},
{6226,6171,6117,6063,6008,5953,5899,5844,5788,5733,5677,5621,5564,5507,5450,5392,5333,5274,5214,5154,5093,5031,4968,4904,4840,4774,4707,4640,4571,4500,4429,4355,4281,4204,4126,4046,3964,3880},
{6553,6496,6439,6382,6324,6267,6209,6151,6093,6034,5976,5916,5857,5797,5736,5675,5614,5552,5489,5425,5361,5296,5230,5163,5095,5025,4955,4884,4811,4737,4662,4585,4506,4425,4343,4259,4173,4084},
{6881,6821,6761,6701,6640,6580,6519,6459,6398,6336,6274,6212,6150,6087,6023,5959,5895,5829,5763,5696,5629,5560,5491,5421,5349,5277,5203,5128,5052,4974,4895,4814,4731,4647,4560,4472,4381,4288},
{7209,7146,7083,7020,6957,6893,6830,6766,6702,6638,6573,6508,6443,6377,6310,6243,6175,6107,6038,5968,5897,5825,5752,5679,5604,5528,5451,5372,5292,5211,5128,5043,4956,4868,4778,4685,4590,4493},
{7536,7471,7405,7339,7273,7207,7140,7074,7007,6940,6872,6804,6735,6666,6597,6527,6456,6384,6312,6239,6165,6090,6014,5937,5859,5779,5699,5616,5533,5448,5361,5272,5182,5089,4995,4898,4799,4697},
{7864,7795,7727,7658,7589,7520,7451,7381,7311,7241,7171,7100,7028,6956,6884,6810,6737,6662,6586,6510,6433,6355,6275,6195,6113,6031,5946,5861,5773,5685,5594,5501,5407,5311,5212,5111,5007,4901},
{8192,8120,8049,7977,7905,7833,7761,7689,7616,7543,7470,7396,7321,7246,7171,7094,7017,6940,6861,6781,6701,6619,6537,6453,6368,6282,6194,6105,6014,5921,5827,5731,5632,5532,5429,5324,5216,5105},
{8519,8445,8371,8296,8222,8147,8072,7996,7921,7845,7768,7691,7614,7536,7457,7378,7298,7217,7135,7053,6969,6884,6798,6711,6623,6533,6442,6349,6254,6158,6060,5960,5858,5753,5646,5537,5425,5309},
{8847,8770,8693,8615,8538,8460,8382,8304,8225,8146,8067,7987,7907,7826,7744,7662,7579,7495,7410,7324,7237,7149,7060,6969,6878,6784,6690,6593,6495,6395,6293,6189,6083,5974,5863,5750,5633,5514},
{9175,9095,9015,8934,8854,8773,8693,8612,8530,8448,8366,8283,8200,8116,8031,7946,7859,7772,7684,7595,7505,7414,7321,7228,7132,7036,6937,6837,6736,6632,6526,6418,6308,6196,6081,5963,5842,5718},
{9502,9419,9337,9253,9170,9087,9003,8919,8835,8750,8665,8579,8493,8406,8318,8229,8140,8050,7959,7866,7773,7679,7583,7486,7387,7287,7185,7082,6976,6869,6759,6648,6534,6417,6298,6176,6050,5922},
{9830,9744,9658,9573,9486,9400,9314,9227,9139,9052,8963,8875,8785,8695,8605,8513,8421,8327,8233,8138,8041,7943,7844,7744,7642,7538,7433,7326,7217,7106,6992,6877,6759,6638,6515,6389,6259,6126},
{10158,10069,9980,9892,9803,9713,9624,9534,9444,9353,9262,9171,9078,8985,8891,8797,8701,8605,8508,8409,8309,8208,8106,8002,7897,7789,7681,7570,7457,7342,7225,7106,6984,6860,6732,6601,6468,6331},
{10485,10394,10302,10211,10119,10027,9934,9842,9749,9655,9561,9466,9371,9275,9178,9081,8982,8883,8782,8680,8577,8473,8367,8260,8151,8041,7928,7814,7698,7579,7459,7335,7209,7081,6949,6814,6676,6535},
{10813,10719,10624,10530,10435,10340,10245,10149,10053,9957,9860,9762,9664,9565,9465,9364,9263,9160,9056,8951,8845,8738,8629,8518,8406,8292,8176,8058,7938,7816,7692,7565,7435,7302,7166,7027,6885,6739},
{11141,11044,10946,10849,10751,10653,10555,10457,10358,10259,10159,10058,9957,9855,9752,9648,9543,9438,9331,9223,9113,9003,8890,8776,8661,8543,8424,8303,8179,8053,7925,7794,7660,7523,7384,7240,7094,6943},
{11468,11368,11268,11168,11067,10967,10866,10764,10663,10560,10457,10354,10250,10145,10039,9932,9824,9715,9605,9494,9381,9267,9152,9034,8915,8795,8672,8547,8420,8290,8158,8023,7885,7745,7601,7453,7302,7147},
{11796,11693,11590,11487,11384,11280,11176,11072,10967,10862,10756,10650,10542,10434,10326,10216,10105,9993,9880,9765,9649,9532,9413,9293,9170,9046,8919,8791,8660,8527,8391,8252,8111,7966,7818,7666,7511,7352},
{12124,12018,11912,11806,11700,11593,11487,11379,11272,11164,11055,10945,10835,10724,10612,10500,10386,10270,10154,10037,9917,9797,9675,9551,9425,9297,9167,9035,8901,8764,8624,8481,8336,8187,8035,7879,7720,7556},
{12451,12343,12234,12125,12016,11907,11797,11687,11576,11465,11354,11241,11128,11014,10899,10783,10666,10548,10429,10308,10185,10062,9936,9809,9680,9548,9415,9279,9141,9000,8857,8711,8561,8408,8252,8092,7928,7760},
{12779,12668,12556,12444,12332,12220,12108,11995,11881,11767,11652,11537,11421,11304,11186,11067,10947,10826,10703,10579,10454,10326,10198,10067,9934,9800,9663,9523,9382,9237,9090,8940,8786,8630,8469,8305,8137,7964},
{13107,12992,12878,12763,12649,12533,12418,12302,12186,12069,11951,11833,11714,11594,11473,11351,11228,11103,10977,10850,10722,10591,10459,10325,10189,10051,9910,9768,9622,9474,9323,9169,9012,8851,8686,8518,8345,8168},
{13434,13317,13200,13082,12965,12847,12728,12610,12490,12371,12250,12129,12007,11884,11760,11635,11508,11381,11252,11122,10990,10856,10721,10583,10444,10302,10158,10012,9863,9711,9556,9398,9237,9072,8904,8731,8554,8373},
{13762,13642,13522,13402,13281,13160,13039,12917,12795,12672,12549,12425,12300,12174,12046,11918,11789,11658,11526,11393,11258,11121,10982,10841,10698,10553,10406,10256,10103,9948,9789,9628,9462,9294,9121,8944,8763,8577},
{14090,13967,13844,13721,13597,13473,13349,13225,13100,12974,12848,12720,12592,12463,12333,12202,12070,11936,11801,11664,11526,11386,11243,11099,10953,10805,10654,10500,10344,10185,10022,9857,9688,9515,9338,9157,8971,8781},
{14417,14292,14166,14040,13913,13787,13660,13532,13404,13276,13146,13016,12885,12753,12620,12486,12350,12214,12075,11935,11794,11650,11505,11358,11208,11056,10902,10744,10585,10422,10256,10086,9913,9736,9555,9370,9180,8985},
{14745,14616,14488,14359,14230,14100,13970,13840,13709,13577,13445,13312,13178,13043,12907,12770,12631,12491,12350,12207,12062,11915,11766,11616,11463,11307,11149,10989,10825,10658,10489,10315,10138,9957,9772,9583,9389,9190},
{15073,14941,14810,14678,14546,14413,14281,14147,14014,13879,13744,13608,13471,13333,13194,13053,12912,12769,12624,12478,12330,12180,12028,11874,11717,11559,11397,11233,11066,10895,10722,10544,10364,10179,9989,9796,9597,9394},
{15400,15266,15132,14997,14862,14727,14591,14455,14318,14181,14043,13904,13764,13623,13481,13337,13192,13046,12899,12749,12598,12445,12289,12132,11972,11810,11645,11477,11306,11132,10955,10774,10589,10400,10207,10009,9806,9598},
{15728,15591,15454,15316,15178,15040,14902,14763,14623,14483,14342,14200,14057,13913,13767,13621,13473,13324,13173,13020,12866,12709,12551,12390,12227,12061,11893,11721,11547,11369,11188,11003,10814,10621,10424,10222,10015,9802},
{16056,15916,15775,15635,15494,15353,15212,15070,14928,14784,14640,14495,14349,14202,14054,13905,13754,13601,13447,13292,13134,12974,12812,12648,12482,12312,12140,11965,11787,11606,11421,11232,11039,10842,10641,10435,10223,10006},
{16384,16241,16097,15954,15811,15667,15523,15378,15232,15086,14939,14791,14642,14492,14341,14189,14035,13879,13722,13563,13402,13239,13074,12906,12736,12564,12388,12210,12028,11843,11654,11461,11265,11064,10858,10648,10432,10211},
{16711,16565,16419,16273,16127,15980,15833,15685,15537,15388,15238,15087,14935,14782,14628,14472,14315,14157,13996,13834,13670,13504,13335,13164,12991,12815,12636,12454,12268,12080,11887,11691,11490,11285,11075,10861,10640,10415},
{17039,16890,16741,16592,16443,16293,16143,15993,15842,15689,15537,15383,15228,15072,14915,14756,14596,14434,14271,14105,13938,13769,13597,13423,13246,13066,12884,12698,12509,12316,12120,11920,11715,11506,11292,11073,10849,10619},
{17367,17215,17063,16911,16759,16607,16454,16300,16146,15991,15835,15679,15521,15362,15202,15040,14877,14712,14545,14377,14206,14033,13858,13681,13500,13317,13131,12942,12750,12553,12353,12149,11941,11728,11510,11286,11058,10823},
{17694,17540,17385,17231,17076,16920,16764,16608,16451,16293,16134,15974,15814,15652,15488,15324,15157,14989,14820,14648,14474,14298,14120,13939,13755,13569,13379,13186,12990,12790,12586,12378,12166,11949,11727,11499,11266,11027},
{18022,17865,17707,17550,17392,17233,17075,16915,16755,16595,16433,16270,16107,15942,15775,15607,15438,15267,15094,14919,14742,14563,14381,14197,14010,13820,13627,13431,13231,13027,12819,12608,12391,12170,11944,11712,11475,11232},
{18350,18189,18029,17869,17708,17547,17385,17223,17060,16896,16732,16566,16399,16231,16062,15891,15719,15545,15368,15190,15010,14828,14643,14455,14265,14071,13875,13675,13471,13264,13052,12837,12616,12391,12161,11925,11684,11436},
{18677,18514,18351,18188,18024,17860,17696,17531,17365,17198,17031,16862,16692,16521,16349,16175,15999,15822,15643,15462,15278,15092,14904,14713,14519,14323,14122,13919,13712,13501,13286,13066,12842,12613,12378,12138,11892,11640},
{19005,18839,18673,18507,18340,18174,18006,17838,17669,17500,17329,17158,16985,16811,16636,16459,16280,16100,15917,15733,15546,15357,15166,14971,14774,14574,14370,14163,13952,13738,13519,13295,13067,12834,12595,12351,12101,11844},
{19333,19164,18995,18826,18657,18487,18317,18146,17974,17802,17628,17454,17278,17101,16922,16742,16561,16377,16192,16004,15814,15622,15427,15229,15029,14825,14618,14407,14193,13974,13752,13524,13292,13055,12813,12564,12310,12048},
{19660,19489,19317,19145,18973,18800,18627,18453,18279,18103,17927,17749,17571,17391,17209,17026,16841,16655,16466,16275,16082,15887,15689,15488,15284,15076,14866,14652,14433,14211,13985,13754,13518,13276,13030,12777,12518,12253},
{19988,19813,19639,19464,19289,19114,18937,18761,18583,18405,18226,18045,17864,17681,17496,17310,17122,16932,16741,16547,16350,16152,15950,15746,15538,15328,15114,14896,14674,14448,14218,13983,13743,13498,13247,12990,12727,12457},
{20316,20138,19961,19783,19605,19427,19248,19068,18888,18707,18524,18341,18156,17970,17783,17594,17403,17210,17015,16818,16618,16416,16212,16004,15793,15579,15361,15140,14915,14685,14451,14212,13968,13719,13464,13203,12935,12661},
{20643,20463,20283,20102,19921,19740,19558,19376,19193,19008,18823,18637,18449,18260,18070,17878,17684,17488,17290,17089,16886,16681,16473,16262,16048,15830,15609,15384,15155,14922,14684,14441,14194,13940,13681,13416,13144,12865},
{20971,20788,20605,20421,20238,20054,19869,19683,19497,19310,19122,18933,18742,18550,18357,18161,17964,17765,17564,17360,17154,16946,16734,16520,16302,16081,15857,15628,15396,15159,14917,14671,14419,14162,13898,13629,13353,13070},
{21299,21113,20927,20740,20554,20367,20179,19991,19802,19612,19421,19229,19035,18840,18643,18445,18245,18043,17838,17632,17423,17211,16996,16778,16557,16333,16105,15872,15636,15396,15150,14900,14644,14383,14116,13842,13561,13274},
{21626,21437,21249,21060,20870,20680,20490,20299,20107,19914,19720,19524,19328,19130,18930,18729,18526,18320,18113,17903,17691,17475,17257,17036,16812,16584,16352,16117,15877,15632,15383,15129,14869,14604,14333,14055,13770,13478},
{21954,21762,21571,21379,21186,20994,20800,20606,20411,20215,20018,19820,19621,19420,19217,19013,18806,18598,18387,18174,17959,17740,17519,17294,17067,16835,16600,16361,16117,15869,15616,15358,15095,14825,14550,14268,13979,13682},
{22282,22087,21893,21698,21503,21307,21111,20914,20716,20517,20317,20116,19914,19710,19504,19296,19087,18875,18662,18445,18227,18005,17780,17553,17321,17087,16848,16605,16358,16106,15849,15588,15320,15047,14767,14481,14187,13886},
{22609,22412,22214,22017,21819,21620,21421,21221,21020,20819,20616,20412,20206,19999,19791,19580,19368,19153,18936,18717,18495,18270,18042,17811,17576,17338,17096,16849,16598,16343,16083,15817,15545,15268,14984,14694,14396,14091},
{22937,22737,22536,22336,22135,21934,21732,21529,21325,21120,20915,20708,20499,20289,20077,19864,19648,19431,19211,18988,18763,18535,18303,18069,17831,17589,17343,17093,16839,16580,16316,16046,15771,15489,15201,14907,14605,14295},
{23265,23062,22858,22655,22451,22247,22042,21836,21630,21422,21213,21003,20792,20579,20364,20148,19929,19708,19485,19259,19031,18799,18565,18327,18086,17840,17591,17338,17080,16817,16549,16275,15996,15710,15418,15120,14813,14499},
{23592,23386,23180,22974,22767,22560,22352,22144,21934,21724,21512,21299,21085,20869,20651,20431,20210,19986,19759,19531,19299,19064,18826,18585,18340,18092,17839,17582,17320,17054,16782,16504,16221,15932,15636,15333,15022,14703},
{23920,23711,23502,23293,23084,22874,22663,22451,22239,22026,21811,21595,21378,21159,20938,20715,20490,20263,20034,19802,19567,19329,19088,18843,18595,18343,18087,17826,17561,17290,17015,16734,16447,16153,15853,15545,15230,14907},
{24248,24036,23824,23612,23400,23187,22973,22759,22544,22327,22110,21891,21671,21449,21225,20999,20771,20541,20308,20073,19835,19594,19349,19101,18850,18594,18334,18070,17801,17527,17248,16963,16672,16374,16070,15758,15439,15112},
{24575,24361,24146,23931,23716,23500,23284,23067,22848,22629,22409,22187,21963,21738,21512,21283,21052,20819,20583,20344,20103,19858,19611,19359,19104,18845,18582,18314,18042,17764,17481,17192,16897,16596,16287,15971,15648,15316},
{24903,24686,24468,24250,24032,23814,23594,23374,23153,22931,22707,22483,22256,22028,21798,21567,21333,21096,20857,20616,20371,20123,19872,19618,19359,19097,18830,18559,18282,18001,17714,17421,17122,16817,16504,16184,15856,15520},
{25231,25010,24790,24569,24348,24127,23905,23682,23458,23233,23006,22778,22549,22318,22085,21850,21613,21374,21132,20887,20639,20388,20134,19876,19614,19348,19078,18803,18523,18238,17947,17651,17348,17038,16721,16397,16065,15724},
{25558,25335,25112,24889,24665,24440,24215,23989,23762,23534,23305,23074,22842,22608,22372,22134,21894,21651,21406,21158,20907,20653,20395,20134,19869,19599,19325,19047,18763,18475,18180,17880,17573,17259,16939,16610,16274,15928},
{25886,25660,25434,25208,24981,24754,24526,24297,24067,23836,23604,23370,23135,22898,22659,22418,22175,21929,21681,21429,21175,20918,20657,20392,20123,19851,19573,19291,19004,18712,18413,18109,17798,17481,17156,16823,16482,16133},
{26214,25985,25756,25527,25297,25067,24836,24604,24372,24138,23903,23666,23428,23188,22946,22702,22455,22206,21955,21701,21443,21182,20918,20650,20378,20102,19821,19535,19245,18948,18646,18338,18024,17702,17373,17036,16691,16337},
{26541,26310,26078,25846,25613,25380,25146,24912,24676,24439,24201,23962,23721,23478,23233,22985,22736,22484,22229,21972,21711,21447,21180,20908,20633,20353,20069,19780,19485,19185,18879,18567,18249,17923,17590,17249,16900,16541},
{26869,26634,26400,26165,25930,25694,25457,25219,24981,24741,24500,24258,24013,23767,23519,23269,23017,22762,22504,22243,21979,21712,21441,21166,20888,20604,20317,20024,19726,19422,19113,18797,18474,18144,17807,17462,17108,16745},
{27197,26959,26722,26484,26246,26007,25767,25527,25285,25043,24799,24553,24306,24057,23806,23553,23297,23039,22778,22514,22247,21977,21703,21424,21142,20856,20564,20268,19966,19659,19346,19026,18699,18366,18024,17675,17317,16950},
{27524,27284,27044,26803,26562,26320,26078,25835,25590,25345,25098,24849,24599,24347,24093,23837,23578,23317,23053,22786,22515,22241,21964,21683,21397,21107,20812,20512,20207,19896,19579,19255,18925,18587,18242,17888,17526,17154},
{27852,27609,27366,27122,26878,26634,26388,26142,25895,25646,25396,25145,24892,24637,24380,24120,23859,23594,23327,23057,22783,22506,22225,21941,21652,21358,21060,20756,20447,20133,19812,19484,19150,18808,18459,18101,17734,17358},
{28180,27934,27688,27441,27194,26947,26699,26450,26199,25948,25695,25441,25185,24927,24667,24404,24139,23872,23602,23328,23051,22771,22487,22199,21906,21609,21308,21001,20688,20370,20045,19714,19375,19030,18676,18314,17943,17562},
{28507,28258,28010,27760,27511,27260,27009,26757,26504,26250,25994,25737,25478,25217,24953,24688,24420,24150,23876,23599,23319,23036,22748,22457,22161,21861,21555,21245,20928,20606,20278,19943,19601,19251,18893,18527,18151,17766},
{28835,28583,28331,28079,27827,27574,27320,27065,26809,26551,26293,26032,25770,25506,25240,24972,24701,24427,24150,23871,23587,23301,23010,22715,22416,22112,21803,21489,21169,20843,20511,20172,19826,19472,19110,18740,18360,17971},
{29163,28908,28653,28398,28143,27887,27630,27372,27113,26853,26592,26328,26063,25796,25527,25256,24982,24705,24425,24142,23855,23565,23271,22973,22671,22363,22051,21733,21410,21080,20744,20401,20051,19693,19327,18953,18569,18175},
{29490,29233,28975,28718,28459,28200,27941,27680,27418,27155,26890,26624,26356,26086,25814,25539,25262,24982,24699,24413,24124,23830,23533,23231,22925,22615,22299,21977,21650,21317,20977,20631,20277,19915,19545,19166,18777,18379},
{29818,29558,29297,29037,28775,28514,28251,27987,27723,27457,27189,26920,26649,26376,26101,25823,25543,25260,24974,24684,24392,24095,23794,23489,23180,22866,22546,22221,21891,21554,21210,20860,20502,20136,19762,19379,18986,18583},
{30146,29883,29619,29356,29092,28827,28561,28295,28027,27758,27488,27216,26942,26666,26388,26107,25824,25537,25248,24956,24660,24360,24056,23748,23435,23117,22794,22466,22131,21791,21443,21089,20727,20357,19979,19592,19195,18787},
{30473,30207,29941,29675,29408,29140,28872,28602,28332,28060,27787,27512,27235,26956,26674,26391,26104,25815,25523,25227,24928,24625,24317,24006,23690,23368,23042,22710,22372,22027,21676,21318,20952,20579,20196,19804,19403,18992},
{30801,30532,30263,29994,29724,29454,29182,28910,28637,28362,28085,27807,27528,27245,26961,26674,26385,26093,25797,25498,25196,24889,24579,24264,23944,23620,23290,22954,22612,22264,21910,21547,21178,20800,20413,20017,19612,19196},
{31129,30857,30585,30313,30040,29767,29493,29218,28941,28664,28384,28103,27820,27535,27248,26958,26666,26370,26071,25769,25464,25154,24840,24522,24199,23871,23537,23198,22853,22501,22143,21777,21403,21021,20630,20230,19821,19400},
{31456,31182,30907,30632,30356,30080,29803,29525,29246,28965,28683,28399,28113,27825,27535,27242,26946,26648,26346,26041,25732,25419,25102,24780,24454,24122,23785,23442,23094,22738,22376,22006,21628,21242,20848,20443,20029,19604},
{31784,31507,31229,30951,30673,30394,30114,29833,29551,29267,28982,28695,28406,28115,27822,27526,27227,26925,26620,26312,26000,25684,25363,25038,24708,24373,24033,23687,23334,22975,22609,22235,21854,21464,21065,20656,20238,19809},
{32112,31831,31551,31270,30989,30707,30424,30140,29855,29569,29281,28991,28699,28405,28108,27810,27508,27203,26895,26583,26268,25948,25625,25296,24963,24625,24281,23931,23575,23212,22842,22464,22079,21685,21282,20869,20446,20013},
{32439,32156,31873,31589,31305,31020,30735,30448,30160,29870,29579,29287,28992,28695,28395,28093,27788,27480,27169,26854,26536,26213,25886,25554,25218,24876,24528,24175,23815,23449,23075,22694,22304,21906,21499,21082,20655,20217},
{32767,32481,32195,31908,31621,31334,31045,30755,30464,30172,29878,29582,29285,28985,28682,28377,28069,27758,27444,27126,26804,26478,26148,25813,25473,25127,24776,24419,24056,23685,23308,22923,22529,22127,21716,21295,20864,20421}
};


/* Simple Torque vectoring routine which only decreases torque on inner wheel and increases torque on outer wheel */
void torqueVector(uint16_t velocity, uint8_t steeringDir, uint8_t steeringDeg) 
{
	if (velocity > 5)
	{
		if (steeringDir == 1)	//Steering right
		{
			torqueR = simple_ackerman[velocity][steeringDeg]; 
			if (torqueR > torqueSetpoint) torqueR = tractionControl(torqueSetpoint, wheelFrontR, wheelRearR);
			else torqueR = tractionControl(torqueR, wheelFrontR, wheelRearR);
			torqueL = tractionControl(torqueSetpoint*2-torqueR, wheelFrontL, wheelRearL);
			

		}
		else										//steering left
		{
			torqueL = simple_ackerman[velocity][steeringDeg]; 
			if (torqueL > torqueSetpoint) torqueL = tractionControl(torqueSetpoint, wheelFrontL, wheelRearL);
			else torqueL = tractionControl(torqueL, wheelFrontL, wheelRearL);
			torqueR = tractionControl(torqueSetpoint*2-torqueL, wheelFrontR, wheelRearR);
		}
		
	}
}

/* Function only works when accelerating. Not when deccelerating */
uint16_t tractionControl(uint16_t torque, uint16_t front, uint16_t rear)
{	
	forhold = (double)rear/(double)front;
		
	if(forhold > MAX_SPIN && forhold > 0) /* Hvis bakhjul går  mer enn 15% raskere enn forhul */
	{
		torque = torque*forhold*(1+GRADIENT_AS);
	}
	return torque;
	
}

void readRPM(uint8_t position, uint16_t left, uint16_t right) 
{
	if (position == 1) // front
	{
		wheelFrontR = right;
		wheelFrontL = left;
		wheelsRightUpdated |=0x01;
		wheelsLeftUpdated	 |=0x01;
		if (wheelsRightUpdated == 0x11)
		{
			wheelsRightUpdated = 0x00;
			__disable_irq();
			torqueVector(100*((wheelFrontR+wheelFrontL)>>1)/MAXRPM, steeringDirection, steeringDegrees);
			setTorque(torqueR, torqueL);
			__enable_irq();
			
		}
	}
	else	// rear
	{
		wheelRearR = right;
		wheelRearL = left;
		wheelsRightUpdated |=0x10;
		wheelsLeftUpdated	 |=0x10;
		if (wheelsLeftUpdated == 0x11)
		{
			wheelsLeftUpdated = 0x00;
			__disable_irq();
			torqueVector(100*((wheelFrontR+wheelFrontL)>>1)/MAXRPM, steeringDirection, steeringDegrees);
			setTorque(torqueR, torqueL);
			__enable_irq();
		}
		
	}
}

void readEncoders(uint8_t torque, uint16_t brake, uint8_t steeringDir, uint8_t steeringDeg)
{
	torqueSetpoint = torque;
	brakeSetpoint  = brake;
	steeringDirection = steeringDir;
	steeringDegrees = steeringDeg;
}	

